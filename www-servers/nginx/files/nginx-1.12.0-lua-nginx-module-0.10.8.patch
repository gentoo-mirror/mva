diff -NaurBwd a/src/ngx_http_lua_common.h b/src/ngx_http_lua_common.h
--- a/src/ngx_http_lua_common.h	2017-04-09 04:11:54.000000000 +0700
+++ b/src/ngx_http_lua_common.h	2017-04-13 01:02:36.283387436 +0700
@@ -199,6 +199,11 @@
                                                 of reqeusts */
     ngx_uint_t           malloc_trim_req_count;
 
+#if defined(nginx_version) && nginx_version >= 1011011
+    ngx_buf_t          **busy_bufs_ptrs;
+    ngx_int_t            prealloc_nbusy;
+#endif
+
     unsigned             requires_header_filter:1;
     unsigned             requires_body_filter:1;
     unsigned             requires_capture_filter:1;
diff -NaurBwd a/src/ngx_http_lua_headers.c b/src/ngx_http_lua_headers.c
--- a/src/ngx_http_lua_headers.c	2017-04-09 04:11:54.000000000 +0700
+++ b/src/ngx_http_lua_headers.c	2017-04-13 01:02:36.283387436 +0700
@@ -26,6 +26,9 @@
 static int ngx_http_lua_ngx_req_header_clear(lua_State *L);
 static int ngx_http_lua_ngx_req_header_set(lua_State *L);
 static int ngx_http_lua_ngx_resp_get_headers(lua_State *L);
+#if defined(nginx_version) && nginx_version >= 1011011
+void ngx_http_lua_ngx_raw_header_cleanup(void *data);
+#endif
 
 
 static int
@@ -77,6 +80,11 @@
     size_t                       size;
     ngx_buf_t                   *b, *first = NULL;
     ngx_int_t                    i, j;
+#if defined(nginx_version) && nginx_version >= 1011011
+    ngx_buf_t                  **bb;
+    ngx_chain_t                 *cl;
+    ngx_http_lua_main_conf_t    *lmcf;
+#endif
     ngx_connection_t            *c;
     ngx_http_request_t          *r, *mr;
     ngx_http_connection_t       *hc;
@@ -93,6 +101,10 @@
         return luaL_error(L, "no request object found");
     }
 
+#if defined(nginx_version) && nginx_version >= 1011011
+    lmcf = ngx_http_get_module_main_conf(r, ngx_http_lua_module);
+#endif
+
     ngx_http_lua_check_fake_request(L, r);
 
     mr = r->main;
@@ -109,8 +121,13 @@
     dd("hc->nbusy: %d", (int) hc->nbusy);
 
     if (hc->nbusy) {
+#if defined(nginx_version) && nginx_version >= 1011011
+        dd("hc->busy: %p %p %p %p", hc->busy->buf->start, hc->busy->buf->pos,
+           hc->busy->buf->last, hc->busy->buf->end);
+#else
         dd("hc->busy: %p %p %p %p", hc->busy[0]->start, hc->busy[0]->pos,
            hc->busy[0]->last, hc->busy[0]->end);
+#endif
     }
 
     dd("request line: %p %p", mr->request_line.data,
@@ -146,9 +163,37 @@
     dd("size: %d", (int) size);
 
     if (hc->nbusy) {
+#if defined(nginx_version) && nginx_version >= 1011011
+        if (hc->nbusy > lmcf->prealloc_nbusy) {
+            if (lmcf->busy_bufs_ptrs) {
+                ngx_free(lmcf->busy_bufs_ptrs);
+            }
+
+            lmcf->busy_bufs_ptrs = ngx_alloc(hc->nbusy * sizeof(ngx_buf_t *),
+                                             r->connection->log);
+
+            if (lmcf->busy_bufs_ptrs == NULL) {
+                return luaL_error(L, "no memory");
+            }
+
+            lmcf->prealloc_nbusy = hc->nbusy;
+        }
+
+        bb = lmcf->busy_bufs_ptrs;
+        for (cl = hc->busy; cl; cl = cl->next) {
+            *bb++ = cl->buf;
+        }
+#endif
         b = NULL;
+
+#if defined(nginx_version) && nginx_version >= 1011011
+        bb = lmcf->busy_bufs_ptrs;
+        for (i = hc->nbusy; i > 0; i--) {
+            b = bb[i - 1];
+#else
         for (i = 0; i < hc->nbusy; i++) {
             b = hc->busy[i];
+#endif
 
             dd("busy buf: %d: [%.*s]", (int) i, (int) (b->pos - b->start),
                b->start);
@@ -223,8 +268,15 @@
     }
 
     if (hc->nbusy) {
+
+#if defined(nginx_version) && nginx_version >= 1011011
+        bb = lmcf->busy_bufs_ptrs;
+        for (i = hc->nbusy; i > 0; i--) {
+            b = bb[i - 1];
+#else
         for (i = 0; i < hc->nbusy; i++) {
             b = hc->busy[i];
+#endif
 
             if (!found) {
                 if (b != first) {
@@ -1431,4 +1483,19 @@
 #endif /* NGX_LUA_NO_FFI_API */
 
 
+#if defined(nginx_version) && nginx_version >= 1011011
+void
+ngx_http_lua_ngx_raw_header_cleanup(void *data)
+{
+    ngx_http_lua_main_conf_t  *lmcf;
+
+    lmcf = (ngx_http_lua_main_conf_t *) data;
+
+    if (lmcf->busy_bufs_ptrs) {
+        ngx_free(lmcf->busy_bufs_ptrs);
+    }
+}
+#endif
+
+
 /* vi:set ft=c ts=4 sw=4 et fdm=marker: */
diff -NaurBwd a/src/ngx_http_lua_headers.h b/src/ngx_http_lua_headers.h
--- a/src/ngx_http_lua_headers.h	2017-04-09 04:11:54.000000000 +0700
+++ b/src/ngx_http_lua_headers.h	2017-04-13 01:02:36.283387436 +0700
@@ -15,6 +15,9 @@
 void ngx_http_lua_inject_resp_header_api(lua_State *L);
 void ngx_http_lua_inject_req_header_api(lua_State *L);
 void ngx_http_lua_create_headers_metatable(ngx_log_t *log, lua_State *L);
+#if defined(nginx_version) && nginx_version >= 1011011
+void ngx_http_lua_ngx_raw_header_cleanup(void *data);
+#endif
 
 
 #endif /* _NGX_HTTP_LUA_HEADERS_H_INCLUDED_ */
diff -NaurBwd a/src/ngx_http_lua_module.c b/src/ngx_http_lua_module.c
--- a/src/ngx_http_lua_module.c	2017-04-09 04:11:54.000000000 +0700
+++ b/src/ngx_http_lua_module.c	2017-04-13 01:02:36.283387436 +0700
@@ -28,6 +28,7 @@
 #include "ngx_http_lua_ssl_certby.h"
 #include "ngx_http_lua_ssl_session_storeby.h"
 #include "ngx_http_lua_ssl_session_fetchby.h"
+#include "ngx_http_lua_headers.h"
 
 
 static void *ngx_http_lua_create_main_conf(ngx_conf_t *cf);
@@ -624,7 +625,8 @@
     volatile ngx_cycle_t       *saved_cycle;
     ngx_http_core_main_conf_t  *cmcf;
     ngx_http_lua_main_conf_t   *lmcf;
-#ifndef NGX_LUA_NO_FFI_API
+#if (!defined(NGX_LUA_NO_FFI_API)) \
+    || (defined(nginx_version) && nginx_version >= 1011011)
     ngx_pool_cleanup_t         *cln;
 #endif
 
@@ -716,6 +718,16 @@
     cln->handler = ngx_http_lua_sema_mm_cleanup;
 #endif
 
+#if defined(nginx_version) && nginx_version >= 1011011
+    cln = ngx_pool_cleanup_add(cf->pool, 0);
+    if (cln == NULL) {
+        return NGX_ERROR;
+    }
+
+    cln->data = lmcf;
+    cln->handler = ngx_http_lua_ngx_raw_header_cleanup;
+#endif
+
     if (lmcf->lua == NULL) {
         dd("initializing lua vm");
 
